<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enumerator Login | Municipal Agriculture Office ‚Äì Abra De Ilog</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        body {
            background: url('../../img/mun.png') no-repeat center center fixed;
            background-size: cover;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            position: relative;
        }

        /* üî• Blur Overlay */
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(2px);
            background: rgba(0, 0, 0, 0.15);
            /* optional soft dark overlay */
            z-index: -1;
            /* keeps blur behind everything */
        }

        .login-card {
            background: rgba(255, 255, 255, 0.80);
            padding: 2rem;
            border-radius: 1rem;
            width: 380px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            text-align: center;
            margin-top: 20px;
            backdrop-filter: blur(4px);
            /* Slight blur on the card itself */
        }


        .header-bar {
            background-color: #166534;
            color: white;
            text-align: center;
            padding: 10px 0;
            width: 100%;
            border-bottom: 4px solid #E6B800;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 10;
        }


        .login-card img {
            width: 60px;
            margin-bottom: 10px;
        }

        .login-card h3 {
            color: #166534;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 25px;
        }

        .btn-success {
            background-color: #166534;
            border: none;
        }

        .btn-success:hover {
            background-color: #14532d;
        }

        .btn-secondary {
            background-color: #6c757d;
            border: none;
        }

        #status {
            font-size: 0.9rem;
        }

        .footer {
            color: #fff;
            text-align: center;
            font-size: 13px;
            margin-top: auto;
            background-color: rgba(22, 101, 52, 0.9);
            width: 100%;
            padding: 6px 0;
            position: fixed;
            bottom: 0;
            left: 0;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <div class="header-bar">
        <h5 class="m-0 fw-bold">Municipal Agriculture Office ‚Äì Abra De Ilog</h5>
    </div>

    <!-- Login Card -->
    <div class="login-card">
        <img src="../../img/logo.png" alt="MAO Logo">
        <h3>ENUMERATOR LOGIN PORTAL</h3>
        <p class="text-muted small mb-3">Municipal Agriculture Office ‚Äì Abra De Ilog</p>

        <form id="loginForm">
            <div class="mb-3 text-start">
                <label class="fw-semibold">Username</label>
                <input type="text" id="username" class="form-control" required>
            </div>
            <div class="mb-3 text-start">
                <label class="fw-semibold">Password</label>
                <input type="password" id="password" class="form-control" required>
            </div>

            <button class="btn btn-success w-100 mb-2" id="loginBtn">Sign In</button>
            <button id="offlineBtn" class="btn btn-secondary w-100" disabled>Offline Login</button>
        </form>

        <div id="status" class="mt-3 text-center text-muted small"></div>

        <div class="mt-3">
            <a href="../login.html" class="text-decoration-none small text-success">&larr; Back to User Type
                Selection</a>
        </div>
    </div>

    <div class="footer">
        ¬© 2025 Municipal Agriculture Office | Abra de Ilog Occidental Mindoro
    </div>

    <!-- Login Logic -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const usernameInput = document.querySelector("#username");
            const passwordInput = document.querySelector("#password");
            const loginBtn = document.querySelector("#loginBtn");
            const offlineBtn = document.querySelector("#offlineBtn");
            const statusDiv = document.querySelector("#status");

            async function hashPassword(password) {
                const msgUint8 = new TextEncoder().encode(password);
                const hashBuffer = await crypto.subtle.digest("SHA-256", msgUint8);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
            }

            async function saveUserLocally(username, password) {
                const passwordHash = await hashPassword(password);
                localStorage.setItem("enumeratorUser", JSON.stringify({ username, passwordHash }));
            }

            function updateNetworkStatus() {
                const savedUser = JSON.parse(localStorage.getItem("enumeratorUser") || "null");
                if (navigator.onLine) {
                    statusDiv.innerHTML = savedUser
                        ? `‚úÖ Online. Offline login ready for <b>${savedUser.username}</b>.`
                        : "‚úÖ Online. Login to enable offline access.";
                    offlineBtn.disabled = !savedUser;
                } else {
                    statusDiv.innerHTML = savedUser
                        ? `üì¥ Offline mode. You can still log in as <b>${savedUser.username}</b>.`
                        : "‚ö†Ô∏è Offline mode. No saved user found.";
                    offlineBtn.disabled = !savedUser;
                }
            }

            window.addEventListener("online", updateNetworkStatus);
            window.addEventListener("offline", updateNetworkStatus);

            loginBtn.addEventListener("click", async (e) => {
                e.preventDefault();
                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();

                if (!username || !password) {
                    alert("Please enter both username and password.");
                    return;
                }

                if (!navigator.onLine) {
                    alert("‚ö†Ô∏è You are offline. Use Offline Login instead.");
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append("username", username);
                    formData.append("password", password);

                    const response = await fetch("enumerator_login.php", {
                        method: "POST",
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert("‚úÖ Login successful!");
                        await saveUserLocally(username, password);
                        window.location.href = "enumerator_view.php";
                    } else {
                        alert("‚ùå " + result.message);
                    }
                } catch (err) {
                    alert("‚ùå Network error. Try again later.");
                }
            });

            offlineBtn.addEventListener("click", async (e) => {
                e.preventDefault();
                const savedUser = JSON.parse(localStorage.getItem("enumeratorUser") || "null");
                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();

                if (!savedUser) {
                    alert("‚ö†Ô∏è No offline user saved.");
                    return;
                }

                const enteredHash = await hashPassword(password);
                if (username === savedUser.username && enteredHash === savedUser.passwordHash) {
                    alert("‚úÖ Offline login successful!");
                    window.location.href = "enumerator_view.php";
                } else {
                    alert("‚ùå Invalid offline credentials.");
                }
            });

            updateNetworkStatus();
        });
    </script>

</body>

</html>